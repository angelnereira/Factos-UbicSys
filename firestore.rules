
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Companies can be created by any authenticated user,
    // but can only be read, updated, or deleted by the user who owns them.
    match /companies/{companyId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.authUid;

      // Documents (invoices, etc.) can be managed by the user who owns the parent company.
      // API routes with a service account can bypass this rule.
      match /documents/{documentId} {
        allow read, write: if request.auth != null && request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.authUid;
      }
    }
  }
}
